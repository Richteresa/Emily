// This file was generated by Mendix Studio Pro.
//
// WARNING: Only the following code will be retained when actions are regenerated:
// - the import list
// - the code between BEGIN USER CODE and END USER CODE
// - the code between BEGIN EXTRA CODE and END EXTRA CODE
// Other code you write will be lost the next time you deploy the project.
// Special characters, e.g., é, ö, à, etc. are supported in comments.

package japanesedelivery.actions;

import cn.hutool.json.JSONObject;
import com.google.common.collect.Maps;
import com.mendix.logging.ILogNode;
import com.mendix.systemwideinterfaces.core.IContext;
import com.mendix.webui.CustomJavaAction;
import com.mendix.systemwideinterfaces.core.IMendixObject;
import com.mendix.core.Core;
import cn.hutool.json.JSONUtil;
import com.zto.intl.common.model.PostBody;
import com.zto.intl.common.util.DesUtil;
import com.zto.intl.common.util.HttpInvoke;
import com.zto.intl.common.util.HttpUtil;
import com.zto.intl.common.util.MD5;
import japanesedelivery.proxies.ZtoImportBcOrder;
import japanesedelivery.proxies.ZtoIntlImportOrderResp;
import japanesedelivery.proxies.ZtoIntlOrderItem;
import japanesedelivery.proxies.ZtoOrderEntity;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class ZtoAddBcImportOrder extends CustomJavaAction<IMendixObject>
{
	private IMendixObject __ztoImportBcOrder;
	private japanesedelivery.proxies.ZtoImportBcOrder ztoImportBcOrder;
	private java.util.List<IMendixObject> __ztoIntlOrderItemList;
	private java.util.List<japanesedelivery.proxies.ZtoIntlOrderItem> ztoIntlOrderItemList;
	private IMendixObject __ztoOrderEntity;
	private japanesedelivery.proxies.ZtoOrderEntity ztoOrderEntity;
	private IMendixObject __channelConfig;
	private japanesedelivery.proxies.ChannelConfig channelConfig;

	public ZtoAddBcImportOrder(IContext context, IMendixObject ztoImportBcOrder, java.util.List<IMendixObject> ztoIntlOrderItemList, IMendixObject ztoOrderEntity, IMendixObject channelConfig)
	{
		super(context);
		this.__ztoImportBcOrder = ztoImportBcOrder;
		this.__ztoIntlOrderItemList = ztoIntlOrderItemList;
		this.__ztoOrderEntity = ztoOrderEntity;
		this.__channelConfig = channelConfig;
	}

	@java.lang.Override
	public IMendixObject executeAction() throws Exception
	{
		this.ztoImportBcOrder = this.__ztoImportBcOrder == null ? null : japanesedelivery.proxies.ZtoImportBcOrder.initialize(getContext(), __ztoImportBcOrder);

		this.ztoIntlOrderItemList = java.util.Optional.ofNullable(this.__ztoIntlOrderItemList)
			.orElse(java.util.Collections.emptyList())
			.stream()
			.map(__ztoIntlOrderItemListElement -> japanesedelivery.proxies.ZtoIntlOrderItem.initialize(getContext(), __ztoIntlOrderItemListElement))
			.collect(java.util.stream.Collectors.toList());

		this.ztoOrderEntity = this.__ztoOrderEntity == null ? null : japanesedelivery.proxies.ZtoOrderEntity.initialize(getContext(), __ztoOrderEntity);

		this.channelConfig = this.__channelConfig == null ? null : japanesedelivery.proxies.ChannelConfig.initialize(getContext(), __channelConfig);

		// BEGIN USER CODE
        ILogNode logger = Core.getLogger("JapaneseDelivery");
        
        // 检查必要的参数
        if (channelConfig == null) {
            logger.error("ChannelConfig is null");
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("Channel configuration is missing!");
        }
        
        if (ztoImportBcOrder == null) {
            logger.error("ZtoImportBcOrder is null");
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("Import order data is missing!");
        }
        
        if (ztoOrderEntity == null) {
            logger.error("ZtoOrderEntity is null");
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("Order entity data is missing!");
        }
        
        Map<String, Object> ztoImportBcOrderMap = addBcImportOrder(ztoImportBcOrder,ztoOrderEntity,ztoIntlOrderItemList);
        String secretKey = channelConfig.getsecretKey();
        
        if (secretKey == null || secretKey.trim().isEmpty()) {
            logger.error("SecretKey is null or empty");
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("Channel secret key is missing!");
        }

        String code = "";
        String message = "";
        String messageDetail = "";
        String logisticsId = "";
        String orderId = "";
        String orderNo = "";
        String extended = "";
        String mark = "";

        // 接口测试地址: https://izop-test.zt-express.com/oms/api
        // 接口生产地址: https://izop.zt-express.com/oms/api
        String urlAddress = channelConfig.geturlAddress();
        if (urlAddress == null || urlAddress.trim().isEmpty()) {
            logger.error("URL address is null or empty");
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("Channel URL address is missing!");
        }
        
        String appCode = channelConfig.getappCode();
        if (appCode == null || appCode.trim().isEmpty()) {
            logger.error("AppCode is null or empty");
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("Channel app code is missing!");
        }
        String addBcImportOrderMethod = "addBcImportOrder";
        // String queryBigMarkMethod = "queryBigMark";
        IMendixObject respVO = Core.instantiate(getContext(), ZtoIntlImportOrderResp.getType());
        try {
            String invokeResult = invokeZto(urlAddress,addBcImportOrderMethod,appCode,secretKey, JSONUtil.toJsonStr(ztoImportBcOrderMap));
            logger.info("ZTO "+addBcImportOrderMethod+" response: " + invokeResult);
            String responseData = "";
            JSONObject zTOResponseBody = new JSONObject(invokeResult);
            Boolean success = (Boolean) zTOResponseBody.get("success");
            if (success) {
                responseData = HttpInvoke.getDecodeData(secretKey, (String) zTOResponseBody.get("data"));
                logger.info("ZTO " + addBcImportOrderMethod + " response Decode Data: " + responseData);
                JSONObject zTOResponseData = new JSONObject(responseData);
                logisticsId = (String) zTOResponseData.get("logisticsId");
                orderId = (String) zTOResponseData.get("orderId");
                orderNo = (String) zTOResponseData.get("orderNo");
                mark =(String) zTOResponseData.get("extended");
//                Map<String, Object> ztoQueryBigMarkMap =queryBigMark(ztoImportBcOrder);
//                invokeResult = invokeZto(urlAddress,queryBigMarkMethod,channelConfig.getappCode(),secretKey, JSONUtil.toJsonStr(ztoQueryBigMarkMap));
//                logger.info("ZTO " + queryBigMarkMethod + " response: " + invokeResult);
//                zTOResponseBody = new JSONObject(invokeResult);
//                success = (Boolean) zTOResponseBody.get("success");
//                if (success) {
//                    responseData = HttpInvoke.getDecodeData(secretKey, (String) zTOResponseBody.get("data"));
//                    logger.info("ZTO " + queryBigMarkMethod + " response Decode Data: " + responseData);
//                    extended = (String) zTOResponseData.get("responseData");
//                    mark =(String) new JSONObject(responseData).get("mark");
//                }
            }

            if(!success) {
                JSONObject errorBody = new JSONObject(zTOResponseBody.get("error"));
                if (errorBody != null) {
                    JSONObject zTOResponseError = new JSONObject(errorBody);
                    code = (String) zTOResponseError.get("code");
                    message = (String) zTOResponseError.get("message");
                    messageDetail = zTOResponseError.get("validationError")+"";
                }
            }
            respVO.setValue(getContext(), String.valueOf(ZtoIntlImportOrderResp.MemberNames.logisticsId), logisticsId);
            respVO.setValue(getContext(), String.valueOf(ZtoIntlImportOrderResp.MemberNames.orderId), orderId);
            respVO.setValue(getContext(), String.valueOf(ZtoIntlImportOrderResp.MemberNames.orderNo), orderNo);
            respVO.setValue(getContext(), String.valueOf(ZtoIntlImportOrderResp.MemberNames.extended), extended);
            respVO.setValue(getContext(), String.valueOf(ZtoIntlImportOrderResp.MemberNames.mark), mark);
            respVO.setValue(getContext(), String.valueOf(ZtoIntlImportOrderResp.MemberNames.message), message);
            respVO.setValue(getContext(), String.valueOf(ZtoIntlImportOrderResp.MemberNames.messageDetail),messageDetail);
            respVO.setValue(getContext(), String.valueOf(ZtoIntlImportOrderResp.MemberNames.code), code);
            respVO.setValue(getContext(), String.valueOf(ZtoIntlImportOrderResp.MemberNames.success), success);
            return respVO;
        } catch (Exception e) {
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("Abnormal interface of the courier company!");
        }
		// END USER CODE
	}

	/**
	 * Returns a string representation of this action
	 * @return a string representation of this action
	 */
	@java.lang.Override
	public java.lang.String toString()
	{
		return "ZtoAddBcImportOrder";
	}

	// BEGIN EXTRA CODE
    public String invokeZto(String uri, String method, String appCode, String secretKey, String data) throws Exception {
        ILogNode logger = Core.getLogger("JapaneseDelivery");
        long timestamp = System.currentTimeMillis();
        String url = buildUrl(uri, method, appCode, timestamp);
        String encodeData = getEncodeData(secretKey, data, timestamp);
        logger.info("ZTO request " + method + " : url:" + url + "; request Data: " + data + "; encode Data: " + encodeData);
        return HttpUtil.sendPostJson(url, encodeData);
    }

    private static String buildUrl(String uri, String method, String appCode, Long timestamp) throws IOException {
        Map<String, Object> map = Maps.newHashMap();
        map.put("method", method);
        map.put("timestamp", timestamp);
        map.put("appCode", appCode);
        return HttpUtil.buildRealUrl(uri, map, "UTF-8");
    }

    public static String getEncodeData(String secretKey, String data, long timestamp) throws Exception {
        String sendData = getSendData(secretKey, data, timestamp);
        DesUtil desUtil = DesUtil.setDesKey(secretKey);
        return desUtil.encode(sendData);
    }

    private static String getSendData(String secretKey, String data, long timestamp) throws Exception {
        PostBody body = new PostBody();
        body.setSign(getSign(secretKey, data, timestamp));
        body.setData(data);
        return JSONUtil.toJsonStr(body);
    }

    private static String getSign(String secretKey, String data, long timestamp) throws Exception {
        String md5Encode = timestamp + secretKey + data;
        return MD5.MD5Encode(md5Encode);
    }

    private static Map<String, Object> addBcImportOrder(ZtoImportBcOrder ztoImportBcOrder, ZtoOrderEntity ztoOrderEntity, java.util.List<ZtoIntlOrderItem> ztoIntlOrderItemList) throws Exception {
        // addBcImportOrder（创建进口订单-直邮）
        if (ztoImportBcOrder == null) {
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("ZtoImportBcOrder cannot be null");
        }
        if (ztoOrderEntity == null) {
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("ZtoOrderEntity cannot be null");
        }
        
        Map<String, Object> ztoImportBcOrderMap = createImportBcOrderMap(ztoImportBcOrder);
        Map<String, Object> orderEntityMap = createOrderEntityMap(ztoOrderEntity);
        ztoImportBcOrderMap.put("orderEntity", orderEntityMap);
        List<Map<String, Object>> intlOrderItemList2 = createIntlOrderItemList(ztoIntlOrderItemList);
        ztoImportBcOrderMap.put("intlOrderItemList", intlOrderItemList2);
        return ztoImportBcOrderMap;
    }

    private static Map<String, Object> createImportBcOrderMap(ZtoImportBcOrder ztoImportBcOrder) {
        if (ztoImportBcOrder == null) {
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("ZtoImportBcOrder cannot be null");
        }
        Map<String, Object> ztoImportBcOrderMap = new HashMap<>();
        ztoImportBcOrderMap.put("orderId", ztoImportBcOrder.getorderId());
        ztoImportBcOrderMap.put("consignee", ztoImportBcOrder.getconsignee());
        ztoImportBcOrderMap.put("consigneeAddress", ztoImportBcOrder.getconsigneeAddress());
        ztoImportBcOrderMap.put("consigneeCity", ztoImportBcOrder.getconsigneeCity());
        ztoImportBcOrderMap.put("consigneeCountry", ztoImportBcOrder.getconsigneeCountry());
        ztoImportBcOrderMap.put("consigneeDistrict", ztoImportBcOrder.getconsigneeDistrict());
        ztoImportBcOrderMap.put("consigneeMobile", ztoImportBcOrder.getconsigneeMobile());
        ztoImportBcOrderMap.put("consigneeProv", ztoImportBcOrder.getconsigneeProv());
        ztoImportBcOrderMap.put("consigneeZipCode", ztoImportBcOrder.getconsigneeZipCode());
        ztoImportBcOrderMap.put("customsCode", ztoImportBcOrder.getcustomsCode());
        ztoImportBcOrderMap.put("customerId", ztoImportBcOrder.getcustomerId());
        ztoImportBcOrderMap.put("idType", ztoImportBcOrder.getidType());
        ztoImportBcOrderMap.put("ieType", ztoImportBcOrder.getieType());
        ztoImportBcOrderMap.put("netWeight", ztoImportBcOrder.getnetWeight());
        ztoImportBcOrderMap.put("platformSource", ztoImportBcOrder.getplatformSource());
        ztoImportBcOrderMap.put("shipType", ztoImportBcOrder.getshipType());
        ztoImportBcOrderMap.put("shipper", ztoImportBcOrder.getshipper());
        ztoImportBcOrderMap.put("shipperAddress", ztoImportBcOrder.getshipperAddress());
        ztoImportBcOrderMap.put("shipperCity", ztoImportBcOrder.getshipperCity());
        ztoImportBcOrderMap.put("shipperCountry", ztoImportBcOrder.getshipperCountry());
        ztoImportBcOrderMap.put("shipperDistrict", ztoImportBcOrder.getshipperDistrict());
        ztoImportBcOrderMap.put("shipperMobile", ztoImportBcOrder.getshipperMobile());
        ztoImportBcOrderMap.put("shipperProv", ztoImportBcOrder.getshipperProv());
        ztoImportBcOrderMap.put("stockFlag", ztoImportBcOrder.getstockFlag());
        ztoImportBcOrderMap.put("needBigMark", ztoImportBcOrder.getneedBigMark());
        ztoImportBcOrderMap.put("warehouseCode", ztoImportBcOrder.getwarehouseCode());
        ztoImportBcOrderMap.put("weight", ztoImportBcOrder.getweight());
        return ztoImportBcOrderMap;
    }

    private static Map<String, Object> createOrderEntityMap(ZtoOrderEntity ztoOrderEntity) {
        if (ztoOrderEntity == null) {
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("ZtoOrderEntity cannot be null");
        }
        Map<String, Object> orderEntityMap = new HashMap<>();
        orderEntityMap.put("payableWeight", ztoOrderEntity.getpayableWeight());
        orderEntityMap.put("remark", ztoOrderEntity.getremark());
        orderEntityMap.put("totalShippingFee", ztoOrderEntity.gettotalShippingFee());
        orderEntityMap.put("totalShippingFeeUnit", ztoOrderEntity.gettotalShippingFeeUnit());
        orderEntityMap.put("tradeOrderValue", ztoOrderEntity.gettradeOrderValue());
        orderEntityMap.put("tradeOrderValueUnit", ztoOrderEntity.gettradeOrderValueUnit());
        return orderEntityMap;
    }

    private static List<Map<String, Object>> createIntlOrderItemList(java.util.List<ZtoIntlOrderItem> ztoIntlOrderItemList) {
        List<Map<String, Object>> list = new ArrayList<>();
        if (ztoIntlOrderItemList != null) {
            for (ZtoIntlOrderItem intlOrderItem : ztoIntlOrderItemList) {
                if (intlOrderItem != null) {
                    Map<String, Object> map = createIntlOrderItemMap(intlOrderItem);
                    list.add(map);
                }
            }
        }
        return list;
    }

    private static Map<String, Object> createIntlOrderItemMap(ZtoIntlOrderItem intlOrderItem) {
        if (intlOrderItem == null) {
            throw new com.mendix.systemwideinterfaces.MendixRuntimeException("ZtoIntlOrderItem cannot be null");
        }
        Map<String, Object> intlOrderItemMap = new HashMap<>();
        intlOrderItemMap.put("currencyType", intlOrderItem.getcurrencyType());
        intlOrderItemMap.put("itemId", intlOrderItem.getitemId());
        intlOrderItemMap.put("itemName", intlOrderItem.getitemName());
        intlOrderItemMap.put("itemQuantity", intlOrderItem.getitemQuantity());
        intlOrderItemMap.put("itemUnit", intlOrderItem.getitemUnit());
        intlOrderItemMap.put("itemUnitPrice", intlOrderItem.getitemUnitPrice());
        return intlOrderItemMap;
    }

    private static Map<String, Object> queryBigMark(japanesedelivery.proxies.ZtoImportBcOrder ztoImportBcOrder) throws Exception {
        // queryBigMark(获取大头笔),客户打印中通电子面单时，需要调用此接口获取大头笔信息，大头笔用于国内运输中转。
        Map<String, Object> ztoQueryBigMarkMap = new HashMap<>();
        ztoQueryBigMarkMap.put("receiverAddress", createAddressMap(ztoImportBcOrder.getconsigneeAddress(), ztoImportBcOrder.getconsigneeCity(), ztoImportBcOrder.getconsigneeDistrict(), ztoImportBcOrder.getconsigneeProv()));
        ztoQueryBigMarkMap.put("senderAddress", createAddressMap("花山镇启源大道10号中通快递", "广州市", "花都区", "广东省"));
        ztoQueryBigMarkMap.put("unionCode", ztoImportBcOrder.getorderId());
        return ztoQueryBigMarkMap;
    }

    private static Map<String, Object> createAddressMap(String address, String city, String district, String province) {
        Map<String, Object> addressMap = new HashMap<>();
        addressMap.put("address", address);
        addressMap.put("city", city);
        addressMap.put("district", district);
        addressMap.put("province", province);
        return addressMap;
    }
	// END EXTRA CODE
}
